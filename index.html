<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book Reading Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js"></script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="livekit-integration.js"></script>
</head>
<body>
    <!-- Authentication Check -->
    <script>
        // Check if user is authenticated
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Check if it's a bypass token or regular auth token
            if (token.startsWith('bypass-token-') || token.startsWith('auth-token-')) {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (userInfo.bypass || userInfo.username) {
                    displayUserInfo(userInfo);
                    return;
                }
            }

            // Verify token with backend
            fetch('/api/auth/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = '/login.html';
                } else {
                    // User is authenticated, show user info
                    displayUserInfo(data.user);
                }
            })
            .catch(() => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = '/login.html';
            });
        }


        // Display user information
        function displayUserInfo(user) {
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            userInfo.innerHTML = `
                <div class="user-greeting">
                    <span class="greeting-text">Hi ${user.name || user.username || 'User'}!</span>
                </div>
                <div class="user-avatar">
                    <img src="${user.picture || 'https://via.placeholder.com/40'}" alt="User Avatar" style="width: 30px; height: 30px; border-radius: 50%;">
                </div>
                <div class="user-details">
                    <span class="user-name">${user.name || user.username || 'User'}</span>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            `;
            
            const header = document.querySelector('.header');
            header.appendChild(userInfo);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            // Redirect to login page
            window.location.href = '/login.html';
        }

        // Check authentication on page load
        checkAuthentication();
    </script>

    <div class="container">
        <header class="header">
            <h1><i class="fas fa-microphone"></i> AI Book Reading Assistant</h1>
            <p>Hold your book up to the camera and I'll read it to you!</p>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-circle"></i>
                <span id="connectionText">Connecting to LiveKit...</span>
            </div>
        </header>

        <div class="camera-section">
            <div class="camera-container">
                <div class="camera-header">
                    <h2><i class="fas fa-camera"></i> Book Reader</h2>
                    <p>Hold your book page up to the camera</p>
                </div>
                <div class="camera-display">
                    <video id="webcam" width="640" height="480" autoplay></video>
                    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
                </div>
                <div class="camera-controls">
                    <button id="captureButton" class="capture-btn">
                        <i class="fas fa-book-open"></i>
                        Read This Page
                    </button>
                    <div id="ocrStatus" class="ocr-status">Position book page in camera view and say "read this page"</div>
                </div>
            </div>
        </div>

        <div class="conversation-container">
            <div class="conversation-area" id="conversationArea">
                <div class="message ai-message">
                    <div class="message-content">
                        <i class="fas fa-robot"></i>
                        <p>Hello! I'm your AI reading assistant. The microphone is now active and listening! You can say things like "read this page", "scan the book", or "what do you see" to have me analyze book pages. Just start speaking!</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="textInput" 
                    placeholder="Type your message here..." 
                    rows="3"
                    disabled
                ></textarea>
                <div class="button-group">
                    <button id="voiceButton" class="voice-btn" title="Click to speak">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="sendButton" class="send-btn" title="Send message" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="statusText">Ready to listen</span>
                </div>
                <div class="controls">
                    <button id="clearButton" class="control-btn" title="Clear conversation">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button id="settingsButton" class="control-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label for="voiceSelect">Voice:</label>
                    <select id="voiceSelect">
                        <option value="default">Default Voice</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="speechRate">Speech Rate:</label>
                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="0.85">
                    <span id="rateValue">0.85</span>
                </div>
                <div class="setting-group">
                    <label for="speechPitch">Speech Pitch:</label>
                    <input type="range" id="speechPitch" min="0" max="2" step="0.1" value="1.1">
                    <span id="pitchValue">1.1</span>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
